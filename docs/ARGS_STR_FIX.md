# ‚úÖ –†–ï–®–ï–ù–û: Vast.ai instance startup - args_str vs onstart

## –î–∞—Ç–∞: 1 –¥–µ–∫–∞–±—Ä—è 2025, 20:00

---

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

–ò–Ω—Å—Ç–∞–Ω—Å—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª–∏—Å—å —Å –æ—à–∏–±–∫–æ–π:
```
exec: "bash -c \"cd /workspace...\"": 
stat bash -c "...": no such file or directory
```

–ü—ã—Ç–∞–ª–∏—Å—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `onstart`, –Ω–æ Docker/runc –∏—Å–∫–∞–ª –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª —Å –∏–º–µ–Ω–µ–º –≤—Å–µ–π –∫–æ–º–∞–Ω–¥—ã.

---

## üîç –ü—Ä–∏—á–∏–Ω–∞

**Legacy –∫–æ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª `args_str` (CMD), –∞ –Ω–µ `onstart`!**

### –ë—ã–ª–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
```python
onstart="bash -c 'git clone && ...'"  # ‚ùå Docker –∏—â–µ—Ç —Ñ–∞–π–ª —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º
```

### –°—Ç–∞–ª–æ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
```python
args_str="bash -c 'git clone && ...'"  # ‚úÖ –ü–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∫–∞–∫ CMD –æ–±—Ä–∞–∑–∞
```

---

## üìö –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç Vast.ai API

### –ü–æ–ª—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–Ω—Å—Ç–∞–Ω—Å–∞:

| –ü–æ–ª–µ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å |
|------|-----------|-------------------|
| `args_str` | Shell –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (CMD –æ–±—Ä–∞–∑–∞) | ‚úÖ **–î–ª—è –ª—é–±—ã—Ö –∫–æ–º–∞–Ω–¥** |
| `onstart` | –ü—É—Ç—å –∫ —Å–∫—Ä–∏–ø—Ç—É –≤–Ω—É—Ç—Ä–∏ –æ–±—Ä–∞–∑–∞ | –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –≤ –æ–±—Ä–∞–∑–µ |
| `env` | –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∫—Ä–µ–¥—ã |

### –§–æ—Ä–º–∞—Ç args_str:
```python
args_str = "bash -c '–∫–æ–º–∞–Ω–¥–∞1 && –∫–æ–º–∞–Ω–¥–∞2 && ...'"
```

Vast.ai –ø–µ—Ä–µ–¥–∞—ë—Ç —ç—Ç–æ –∫–∞–∫ **–∞—Ä–≥—É–º–µ–Ω—Ç—ã CMD** –æ–±—Ä–∞–∑–∞, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –∏–º–µ–µ—Ç `ENTRYPOINT ["/entrypoint.sh"]`.

–†–µ–∑—É–ª—å—Ç–∞—Ç:
```bash
/entrypoint.sh bash -c '–∫–æ–º–∞–Ω–¥–∞1 && –∫–æ–º–∞–Ω–¥–∞2 && ...'
```

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –î–æ–±–∞–≤–ª–µ–Ω `args_str` –≤ `VastInstanceConfig`:
```python
@dataclass
class VastInstanceConfig:
    image: str
    disk: int
    env: Dict[str, str]
    args_str: Optional[str] = None  # ‚úÖ Shell –∫–æ–º–∞–Ω–¥–∞
    runtype: str = 'oneshot'
```

### 2. –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–∞ –≤ `batch_processor.py`:
```python
git_clone_cmd = f'cd / && rm -rf /workspace/project && git clone -b {git_branch} {git_repo} /workspace/project'
runner_cmd = 'bash /workspace/project/scripts/remote_runner.sh'
full_cmd = f'{git_clone_cmd} && {runner_cmd}'
shell_cmd = f"bash -c '{full_cmd}'"

instance_config = VastInstanceConfig(
    image=image,
    env={...},
    args_str=shell_cmd,  # ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç!
)
```

### 3. –ö–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ–¥–∞—ë—Ç `args_str` –≤ API:
```python
payload = {
    'client_id': 'me',
    'image': config.image,
    'env': config.env,
    'disk': config.disk,
    'runtype': config.runtype,
}

if config.args_str:
    payload['args_str'] = config.args_str  # ‚úÖ
```

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

**–ò–Ω—Å—Ç–∞–Ω—Å —Ç–µ–ø–µ—Ä—å –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ë–ï–ó –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –æ–±—Ä–∞–∑–∞!**

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ:

1. ‚úÖ Vast.ai —Å–æ–∑–¥–∞—ë—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–∑ –æ–±—Ä–∞–∑–∞ `ghcr.io/zerotouchprod/pytorch-fat-07110957:latest`
2. ‚úÖ –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è `/entrypoint.sh` (–∏–∑ –æ–±—Ä–∞–∑–∞)
3. ‚úÖ Entrypoint –ø–æ–ª—É—á–∞–µ—Ç `args_str` –∫–∞–∫ –∞—Ä–≥—É–º–µ–Ω—Ç—ã
4. ‚úÖ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è: `bash -c 'git clone -b oop2 ... && bash remote_runner.sh'`
5. ‚úÖ –ö–ª–æ–Ω–∏—Ä—É–µ—Ç—Å—è **—Å–≤–µ–∂–∏–π –∫–æ–¥** –∏–∑ –≤–µ—Ç–∫–∏ `oop2`
6. ‚úÖ –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è `remote_runner.sh` –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø—É—Å–∫–∞–µ—Ç –Ω–æ–≤—ã–π Python –∫–æ–¥

---

## üìã –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

‚úÖ **–ù–µ—Ç –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –æ–±—Ä–∞–∑–∞** - –∫–æ–¥ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ Git  
‚úÖ **–ë—ã—Å—Ç—Ä–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - push –≤ oop2 ‚Üí –∑–∞–ø—É—Å–∫–∞–µ–º batch_processor.py  
‚úÖ **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ legacy –∫–æ–¥ (proven)  
‚úÖ **–û—Ç–ª–∞–¥–∫–∞** - –º–æ–∂–Ω–æ SSH –≤ –∏–Ω—Å—Ç–∞–Ω—Å (runtype=oneshot, stopped –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è)  

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ:
- `src/domain/vastai.py` - –¥–æ–±–∞–≤–ª–µ–Ω `args_str`
- `src/infrastructure/vastai/client.py` - –ø–µ—Ä–µ–¥–∞—á–∞ `args_str` –≤ API
- `batch_processor.py` - —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ shell –∫–æ–º–∞–Ω–¥—ã
- `scripts/entrypoint.sh` - —É–±—Ä–∞–Ω–æ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ç–µ–ø–µ—Ä—å –≤ args_str)

### –¢–µ—Å—Ç—ã:
- `tests/unit/test_vastai_client.py` - ‚úÖ –≤—Å–µ –ø—Ä–æ—Ö–æ–¥—è—Ç

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

**–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å:**
```bash
python batch_processor.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
1. ‚úÖ –ò–Ω—Å—Ç–∞–Ω—Å —Å–æ–∑–¥–∞—ë—Ç—Å—è
2. ‚úÖ –ö–ª–æ–Ω–∏—Ä—É–µ—Ç—Å—è –≤–µ—Ç–∫–∞ `oop2`
3. ‚úÖ –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è pipeline —Å –Ω–æ–≤—ã–º –∫–æ–¥–æ–º
4. ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–∞ B2
5. ‚úÖ –ò–Ω—Å—Ç–∞–Ω—Å –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è (–º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏)

---

**–î–∞—Ç–∞:** 1 –¥–µ–∫–∞–±—Ä—è 2025, 20:05  
**Commit:** 5aaea67  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Fixed & Tested  
**–í–∞–∂–Ω–æ:** –û–±—Ä–∞–∑ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞—Ç—å –ù–ï –ù–ê–î–û! üéâ

